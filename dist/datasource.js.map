{"version":3,"sources":["../src/datasource.js"],"names":["dsRegularEscape","value","replace","dsSpecialRegexEscape","_","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","severityLabelName","severityLevels","jsonData","severity_critical","undefined","severity_high","severity_warning","severity_info","severity_label_name","query","matchedFunction","queryTypes","regex","i","length","matches","match","encodeURIComponent","interpolateQueryExpr","unique","Set","results","datasourceRequest","method","then","response","data","forEach","Object","keys","castArray","v","JSON","stringify","has","add","push","text","options","buildQueryParameters","targets","filter","t","hide","when","expr","scopedVars","labelSelector","parseLabelSelector","headers","columnsDict","getColumnsDict","columns","getColumns","row","Array","fill","item","Date","parse","label","annotation","rows","now","variable","defaultFormatFn","escapedValues","map","join","column","input","trim","split","index","severityDefined","labelIndex","selectedLabel","status","message","title","target","targetss","refId","legendFormat","labels","aliasRegex","g1"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class GenericDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.severityLabelName = 'severity';\n\n    this.severityLevels = {}\n    if (instanceSettings.jsonData.severity_critical != undefined) {\n      this.severityLevels[instanceSettings.jsonData.severity_critical] = 4;\n    }\n    if (instanceSettings.jsonData.severity_high != undefined) {\n      this.severityLevels[instanceSettings.jsonData.severity_high] = 3;\n    }\n    if (instanceSettings.jsonData.severity_warning != undefined) {\n      this.severityLevels[instanceSettings.jsonData.severity_warning] = 2;\n    }\n    if (instanceSettings.jsonData.severity_info != undefined) {\n      this.severityLevels[instanceSettings.jsonData.severity_info] = 1;\n    }\n\n    if (instanceSettings.jsonData.severity_label_name != undefined) {\n      this.severityLabelName = instanceSettings.jsonData.severity_label_name;\n    }\n  }\n  metricFindQuery(query) {\n    let matchedFunction = {};\n    if (query) {\n      const queryTypes = [\n        {\n          type: 'names',\n          regex: /^(label|annotation)_names\\((.*?)\\)\\s*$/\n        },\n        {\n          type: 'values',\n          regex: /^(label|annotation)_values\\((?:(.+),\\s*)?([a-zA-Z_][a-zA-Z0-9_]*)\\)\\s*$/\n        },\n        {\n          type: 'key',\n          regex: /^(labels|annotations|receivers|generatorURL)\\((.*?)\\)\\s*$/\n        }\n      ]\n      for (let i = 0; i < queryTypes.length; i++) {\n        queryTypes[i].matches = query.match(queryTypes[i].regex)\n        if (queryTypes[i].matches) {\n          matchedFunction = queryTypes[i];\n          break;\n        }\n      }\n      if (matchedFunction.type) {\n        query = matchedFunction[2] || ''\n      }\n      if (query) {\n        query = encodeURIComponent(this.templateSrv.replace(query, {}, this.interpolateQueryExpr) || \"\");\n      }\n    }\n    let unique = new Set();\n    let results = []\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/api/v1/alerts?silenced=false&inhibited=false&filter=' + query,\n      method: 'GET'\n    }).then(response => {\n      response.data.data.forEach(value => {\n        if (matchedFunction.type === 'key') {\n          value = value[matchedFunction.matches[1]];\n        } else if (matchedFunction.type === 'names') {\n          value = Object.keys(value[matchedFunction.matches[1] + 's'])\n        } else if (matchedFunction.type === 'values') {\n          value = value[matchedFunction.matches[1] + 's'][matchedFunction.matches[3]];\n        }\n        _.castArray(value).forEach(v => {\n          if (v) {\n            if (typeof v === 'object') {\n              v = JSON.stringify(v);\n            }\n            if (!unique.has(v)) {\n              unique.add(v)\n              results.push({ text: v })\n            }\n          }\n        })\n      })\n      return results;\n    });\n  }\n  query(options) {\n    let query = this.buildQueryParameters(options);\n    query.targets = query.targets.filter(t => !t.hide);\n    if (query.targets.length <= 0) {\n      return this.q.when({ data: [] });\n    }\n    let filter = encodeURIComponent(this.templateSrv.replace(query.targets[0].expr, options.scopedVars, this.interpolateQueryExpr) || \"\");\n    // Format data for table panel\n    if (query.targets[0].type === \"table\") {\n      var labelSelector = this.parseLabelSelector(query.targets[0].labelSelector);\n      return this.backendSrv.datasourceRequest({\n        url: this.url + '/api/v1/alerts?silenced=false&inhibited=false&filter=' + filter,\n        data: query,\n        method: 'GET',\n        headers: { 'Content-Type': 'application/json' }\n      }).then(response => {\n        let results = {\n          \"data\": [{\n            \"rows\": [],\n            \"columns\": [],\n            \"type\": \"table\"\n          }]\n        };\n\n        if (response.data && response.data.data && response.data.data.length) {\n          let columnsDict = this.getColumnsDict(response.data.data, labelSelector);\n          results.data[0].columns = this.getColumns(columnsDict);\n\n          for (let i = 0; i < response.data.data.length; i++) {\n            let row = new Array(results.data[0].columns.length).fill(\"\");\n            let item = response.data.data[i];\n            row[0] = [Date.parse(item['startsAt'])];\n\n            for (let label of Object.keys(item['labels'])) {\n              if (label in columnsDict) {\n                if (label === this.severityLabelName) {\n                  row[columnsDict[label]] = this.severityLevels[item['labels'][label]]\n                } else {\n                  row[columnsDict[label]] = item['labels'][label];\n                }\n              }\n            }\n            for (let annotation of Object.keys(item['annotations'])) {\n              if (annotation in columnsDict) {\n                row[columnsDict[annotation]] = item['annotations'][annotation];\n              }\n            }\n            results.data[0].rows.push(row);\n          }\n        }\n        return results;\n      });\n    } else {\n      return this.backendSrv.datasourceRequest({\n        url: this.url + '/api/v1/alerts?silenced=false&inhibited=false&filter=' + filter,\n        data: query,\n        method: 'GET',\n        headers: { 'Content-Type': 'application/json' }\n      }).then(response => {\n        return {\n          \"data\": [{ \"datapoints\": [[response.data.data.length, Date.now()]] }]\n        }\n      });\n    }\n  }\n\n  interpolateQueryExpr(value, variable, defaultFormatFn) {\n    if (typeof value === 'string') {\n      return dsSpecialRegexEscape(value);\n    }\n\n    let escapedValues = _.map(value, dsSpecialRegexEscape);\n    return escapedValues.join('|');\n  }\n\n  getColumns(columnsDict) {\n    let columns = [{ text: \"Time\", type: \"time\" }];\n    for (let column of Object.keys(columnsDict)) {\n      columns.push({ text: column, type: \"string\" })\n    }\n    return columns;\n  }\n\n  // Parses the label list into a map\n  parseLabelSelector(input) {\n    var map;\n    if (typeof (input) === \"undefined\" || input.trim().length === 0) {\n      map = [\"*\"];\n    } else {\n      map = input.trim().split(/\\s*,\\s*/);\n    }\n    return map;\n  }\n\n  // Creates a column index dictionary in to assist in data row construction\n  getColumnsDict(data, labelSelector) {\n    let index = 1; // 0 is the data column\n    let columnsDict = {};\n    let severityDefined = false;\n    for (let i = 0; i < data.length; i++) {\n      for (let labelIndex = 0; labelIndex < labelSelector.length; labelIndex++) {\n        var selectedLabel = labelSelector[labelIndex];\n        if (selectedLabel === \"*\") {\n          // '*' maps to all labels/annotations not already added via the label selector list\n          for (let label of Object.keys(data[i]['labels'])) {\n            if (!(label in columnsDict)) {\n              if (label === this.severityLabelName) {\n                severityDefined = true\n              }\n              columnsDict[label] = index++;\n            }\n          }\n          for (let annotation of Object.keys(data[i]['annotations'])) {\n            if (!(annotation in columnsDict)) {\n              columnsDict[annotation] = index++;\n            }\n          }\n        } else if (!(selectedLabel in columnsDict)) {\n          if (selectedLabel === this.severityLabelName) {\n            severityDefined = true\n          }\n          columnsDict[selectedLabel] = index++;\n        }\n      }\n    }\n    if (!severityDefined) {\n      columnsDict[this.severityLabelName] = index++;\n    }\n    return columnsDict;\n  }\n\n  testDatasource() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/api/v1/status',\n      method: 'GET'\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      }\n    });\n  }\n\n  buildQueryParameters(options) {\n    //remove placeholder targets\n    options.targets = _.filter(options.targets, target => {\n      return target.target !== 'select metric';\n    });\n\n    options.targetss = _.map(options.targets, target => {\n      return {\n        target: this.templateSrv.replace(target.target),\n        expr: target.expr,\n        refId: target.refId,\n        hide: target.hide,\n        type: target.type || 'single',\n        legendFormat: target.legendFormat || \"\"\n      };\n    });\n    return options;\n  }\n\n  formatInstanceText(labels, legendFormat) {\n    if (legendFormat === \"\") {\n      return JSON.stringify(labels);\n    }\n    let aliasRegex = /\\{\\{\\s*(.+?)\\s*\\}\\}/g;\n    return legendFormat.replace(aliasRegex, function (match, g1) {\n      if (labels[g1]) {\n        return labels[g1];\n      }\n      return \"\";\n    });\n  }\n\n\n}\nexport function dsRegularEscape(value) {\n  if (typeof value === 'string') {\n    return value.replace(/'/g, \"\\\\\\\\'\");\n  }\n  return value;\n}\n\nexport function dsSpecialRegexEscape(value) {\n  if (typeof value === 'string') {\n    return dsRegularEscape(value.replace(/\\\\/g, '\\\\\\\\\\\\\\\\').replace(/[$^*{}\\[\\]+?.()]/g, '\\\\\\\\$&'));\n  }\n  return value;\n}\n"]}